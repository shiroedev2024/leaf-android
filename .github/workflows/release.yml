name: Android Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for proper versioning

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      # Cargo cache
      - name: Cache Cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo git
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Create release.properties
        env:
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          UPLOAD_API_URL: ${{ secrets.UPLOAD_API_URL }}
          UPLOAD_API_KEY: ${{ secrets.UPLOAD_API_KEY }}
        run: |
          echo "storeFile=keystore.jks" > release.properties
          echo "storePassword=${STORE_PASSWORD}" >> release.properties
          echo "keyAlias=${KEY_ALIAS}" >> release.properties
          echo "keyPassword=${KEY_PASSWORD}" >> release.properties
          echo "" >> release.properties
          echo "# API Configuration for Release Uploads" >> release.properties
          echo "upload.api.url=${UPLOAD_API_URL}" >> release.properties
          echo "upload.api.key=${UPLOAD_API_KEY}" >> release.properties
          echo "upload.source=direct" >> release.properties

      - name: Decode Keystore
        env:
          ENCODED_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo $ENCODED_KEYSTORE | base64 -d > app/keystore.jks

      - name: Create google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo "$GOOGLE_SERVICES_JSON" > app/google-services.json

      - name: Extract version info
        id: version
        run: |
          VERSION_NAME=$(grep "app.version.name" version.properties | cut -d'=' -f2)
          VERSION_CODE=$(grep "app.version.code" version.properties | cut -d'=' -f2)
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_OUTPUT

      - name: Extract Release Notes
        id: release_notes
        run: |
          # Extract raw notes
          RAW_NOTES=$(grep -oP '(?<=name="release_notes">)[^<]+' app/src/main/res/values/strings.xml)
          
          # Replace \n with actual newlines
          FORMATTED_NOTES=$(echo "$RAW_NOTES" | sed 's/\\n/\n/g')
          
          # Output with EOF delimiter to preserve formatting
          echo "NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$FORMATTED_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build APKs
        run: ./build.sh apk

      - name: Extract APKs from ZIP
        run: |
          mkdir -p release/extracted_apks
          unzip -j "release/leaf-vpn-android_${{ steps.version.outputs.VERSION_NAME }}.zip" -d release/extracted_apks

      - name: Generate Downloads Table
        id: downloads_table
        run: |
          VERSION="${{ steps.version.outputs.VERSION_NAME }}"
          REPO="shiroedev2024/leaf-android"
          TAG="v$VERSION"
          
          # Create markdown table with download links
          echo "DOWNLOADS_TABLE<<EOF" >> $GITHUB_OUTPUT
          echo "| Device Type | Architecture | Download |" >> $GITHUB_OUTPUT
          echo "|------------|--------------|----------|" >> $GITHUB_OUTPUT
          echo "| **All Devices** (Recommended for most users) | Universal | [Download APK](https://github.com/$REPO/releases/download/$TAG/leaf_vpn_${VERSION}_all.apk) |" >> $GITHUB_OUTPUT
          echo "| Modern Android Phones and Tablets (64-bit) | arm64-v8a | [Download APK](https://github.com/$REPO/releases/download/$TAG/leaf_vpn_${VERSION}_arm64-v8a.apk) |" >> $GITHUB_OUTPUT
          echo "| Older Android Phones and Tablets (32-bit) | armeabi-v7a | [Download APK](https://github.com/$REPO/releases/download/$TAG/leaf_vpn_${VERSION}_armeabi-v7a.apk) |" >> $GITHUB_OUTPUT
          echo "| Intel/AMD Android Tablets (32-bit) | x86 | [Download APK](https://github.com/$REPO/releases/download/$TAG/leaf_vpn_${VERSION}_x86.apk) |" >> $GITHUB_OUTPUT
          echo "| Intel/AMD Android Tablets (64-bit) | x86_64 | [Download APK](https://github.com/$REPO/releases/download/$TAG/leaf_vpn_${VERSION}_x86_64.apk) |" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also create a tip section
          echo "DOWNLOAD_TIP<<EOF" >> $GITHUB_OUTPUT
          echo "**Tip**: Not sure which to choose? Download the Universal version - it works on all devices but is larger in size." >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION_NAME }}
          name: Leaf VPN v${{ steps.version.outputs.VERSION_NAME }}
          body: |
            Version Code: ${{ steps.version.outputs.VERSION_CODE }}
            
            ## Release Notes
            ${{ steps.release_notes.outputs.NOTES }}
            
            ## Downloads
            ${{ steps.downloads_table.outputs.DOWNLOADS_TABLE }}
            
            ${{ steps.downloads_table.outputs.DOWNLOAD_TIP }}
          draft: false
          prerelease: false
          files: release/extracted_apks/*
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Publish to Server
        if: ${{ success() }}
        run: |
          # Publish APKs
          ./build.sh apk --publish